---
// P√°gina principal do sistema de registro de atividades complementares
const title = "Registro de Atividades Complementares";

// Configura√ß√µes do EmailJS (do arquivo .env)
const emailConfig = {
  serviceId: import.meta.env.EMAILJS_SERVICE_ID || 'your_service_id_here',
  templateId: import.meta.env.EMAILJS_TEMPLATE_ID || 'your_template_id_here', 
  userId: import.meta.env.EMAILJS_USER_ID || 'your_user_id_here',
  destinationEmails: (import.meta.env.DESTINATION_EMAIL || 'coordenacao@escola.edu.br').split(',').map(e => e.trim())
};

// Configura√ß√µes de Upload de Arquivos (do arquivo .env)
const uploadConfig = {
  maxFileSizeMB: parseInt(import.meta.env.MAX_FILE_SIZE_MB) || 5,
  allowedFileTypes: (import.meta.env.ALLOWED_FILE_TYPES || '.pdf,.jpg,.jpeg,.png,.doc,.docx').split(',')
};

// Configura√ß√µes do Google Sheets e Drive (do arquivo .env)
const googleConfig = {
  enabled: import.meta.env.ENABLE_GOOGLE_INTEGRATION === 'true',
  sheetsId: import.meta.env.GOOGLE_SHEETS_ID || '',
  worksheet: import.meta.env.GOOGLE_SHEETS_WORKSHEET || 'Registros',
  driveFolderId: import.meta.env.GOOGLE_DRIVE_FOLDER_ID || '',
  apiKey: import.meta.env.GOOGLE_API_KEY || ''
};
---

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="description" content="Sistema de Registro de Atividades Complementares" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro de Atividades Complementares</title>
  
  <!-- EmailJS para envio de emails -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  
  <!-- Google APIs para Sheets e Drive -->
  <script src="https://apis.google.com/js/api.js"></script>
  
  <!-- Configura√ß√µes do EmailJS, Upload e Google -->
  <script define:vars={{ emailConfig, uploadConfig, googleConfig }}>
    window.EMAIL_CONFIG = emailConfig;
    window.UPLOAD_CONFIG = uploadConfig;
    window.GOOGLE_CONFIG = googleConfig;
  </script>
  
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.5;
      color: #1f2937;
      background: #f9fafb;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: white;
      padding: 32px;
      text-align: center;
      border-bottom: 1px solid #e5e7eb;
    }

    h1 {
      font-size: 24px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 8px;
    }

    .subtitle {
      color: #6b7280;
      font-size: 14px;
    }

    .form-section {
      padding: 32px;
    }

    .form-group {
      margin-bottom: 24px;
    }

    label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 6px;
    }

    label:has(+ input[required])::after,
    label:contains("*") {
      color: #ef4444;
    }

    input[required] {
      border-left: 3px solid #ef4444;
    }

    input[required]:valid {
      border-left: 3px solid #10b981;
    }

    input[required]:focus {
      border-left: 3px solid #3b82f6;
    }

    input.error {
      border-color: #ef4444 !important;
      border-left: 3px solid #ef4444 !important;
      background-color: #fef2f2;
    }

    .field-error {
      color: #ef4444;
      font-size: 12px;
      margin-top: 4px;
      font-weight: 500;
    }

    #multiple-years-section {
      background: #f0f9ff;
      border: 1px solid #bfdbfe;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }

    #multiple-years-section .help-text {
      color: #1e40af;
      font-weight: 500;
    }

    #activity-years {
      font-family: monospace;
      letter-spacing: 0.5px;
    }

    /* Modal de Confirma√ß√£o */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }

    .modal-content {
      position: relative;
      background: white;
      border-radius: 12px;
      max-width: 700px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 20px;
      color: #111827;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      color: #6b7280;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }

    .modal-close:hover {
      background: #f3f4f6;
      color: #111827;
    }

    .modal-body {
      padding: 24px;
    }

    .confirmation-section {
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid #e5e7eb;
    }

    .confirmation-section:last-of-type {
      border-bottom: none;
    }

    .confirmation-section h3 {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 16px;
    }

    .confirmation-data {
      background: #f9fafb;
      padding: 16px;
      border-radius: 8px;
    }

    .data-row {
      display: flex;
      padding: 8px 0;
      border-bottom: 1px solid #e5e7eb;
    }

    .data-row:last-child {
      border-bottom: none;
    }

    .data-label {
      font-weight: 500;
      color: #374151;
      min-width: 100px;
    }

    .data-value {
      color: #111827;
      flex: 1;
    }

    .confirmation-activities {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .activity-summary {
      background: #f9fafb;
      padding: 12px;
      border-radius: 8px;
      border-left: 4px solid #3b82f6;
    }

    .activity-summary-title {
      font-weight: 500;
      color: #111827;
      margin-bottom: 4px;
    }

    .activity-summary-details {
      font-size: 13px;
      color: #6b7280;
      line-height: 1.5;
    }

    .points-summary-modal {
      background: #f9fafb;
      padding: 16px;
      border-radius: 8px;
    }

    .point-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e5e7eb;
    }

    .point-row:last-child {
      border-bottom: none;
    }

    .point-row.total {
      margin-top: 8px;
      padding-top: 16px;
      border-top: 2px solid #3b82f6;
      font-size: 18px;
      color: #3b82f6;
    }

    .status-section {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 8px;
      padding: 16px;
    }

    .status-message {
      font-size: 14px;
      color: #1e40af;
      line-height: 1.5;
    }

    .confirmation-agreement {
      background: #fef3c7;
      border: 1px solid #fcd34d;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }

    .checkbox-label {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      cursor: pointer;
      margin: 0;
    }

    .checkbox-label input[type="checkbox"] {
      margin-top: 2px;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .checkbox-label span {
      flex: 1;
      font-size: 14px;
      color: #92400e;
      line-height: 1.5;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    @media (max-width: 768px) {
      .modal-content {
        width: 95%;
        max-height: 95vh;
      }

      .modal-header {
        padding: 16px;
      }

      .modal-body {
        padding: 16px;
      }

      .data-row {
        flex-direction: column;
        gap: 4px;
      }

      .data-label {
        min-width: auto;
        font-size: 12px;
      }
    }

    .proof-options {
      display: flex;
      gap: 20px;
      margin-bottom: 16px;
    }

    .proof-option {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .proof-option input[type="radio"] {
      width: auto;
      margin: 0;
    }

    .proof-option label {
      margin: 0;
      font-weight: 500;
      cursor: pointer;
    }

    .file-upload-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .btn-upload {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      width: fit-content;
    }

    .btn-upload:hover {
      background: #2563eb;
    }

    .file-selected {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: #d1fae5;
      border: 1px solid #a7f3d0;
      border-radius: 8px;
      font-size: 14px;
      color: #065f46;
    }

    .btn-remove-file {
      background: #ef4444;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }

    .btn-remove-file:hover {
      background: #dc2626;
    }

    .file-preview {
      margin-top: 12px;
      padding: 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 12px;
      color: #6b7280;
    }

    .required-note {
      font-size: 12px;
      color: #6b7280;
      margin-top: 16px;
      font-style: italic;
    }

    .required-note .required-asterisk {
      color: #ef4444;
      font-weight: bold;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
      background: white;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 12px center;
      background-repeat: no-repeat;
      background-size: 16px;
      padding-right: 40px;
    }

    select:disabled {
      background-color: #f9fafb;
      color: #9ca3af;
      cursor: not-allowed;
    }

    .activities-section {
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
      padding: 32px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 16px;
    }

    .requirement-info {
      background: #eff6ff;
      border: 1px solid #dbeafe;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
      font-size: 14px;
      color: #1e40af;
    }

    .selection-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 24px;
    }

    .activity-details {
      grid-column: 1 / -1;
      background: #f0f9ff;
      border: 1px solid #bfdbfe;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }

    .activity-header {
      font-size: 16px;
      color: #1e40af;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #bfdbfe;
    }

    .additional-fields {
      margin-top: 30px;
      padding: 25px;
      background: #f8fafc;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
    }

    .help-text {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 10px;
      line-height: 1.5;
    }

    .file-info {
      font-size: 14px;
      color: #374151;
      margin-bottom: 15px;
    }

    .file-upload-area {
      border: 2px dashed #d1d5db;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      background: #ffffff;
    }

    .btn-upload {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .btn-upload:hover {
      background: #2563eb;
    }

    .file-upload-help {
      font-size: 12px;
      color: #6b7280;
      margin-top: 8px;
    }

    .file-selected {
      margin-top: 10px;
      padding: 8px 12px;
      background: #d1fae5;
      color: #065f46;
      border-radius: 4px;
      font-size: 14px;
    }



    textarea {
      resize: vertical;
      min-height: 100px;
    }

    .activity-comments {
      font-style: italic;
      line-height: 1.4;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .detail-label {
      font-weight: 500;
      color: #374151;
    }

    .detail-value {
      color: #6b7280;
    }

    .points-badge {
      background: #10b981;
      color: white;
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
      margin-top: 8px;
    }

    .btn {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:hover:not(:disabled) {
      background: #2563eb;
    }

    .btn:disabled {
      background: #e5e7eb;
      color: #9ca3af;
      cursor: not-allowed;
    }

    .btn-add {
      width: 100%;
      background: #10b981;
      padding: 14px;
      font-size: 16px;
      font-weight: 600;
      margin-top: 20px;
    }

    .btn-add:hover:not(:disabled) {
      background: #059669;
    }

    .btn-add[style*="background: #f59e0b"]:hover {
      background: #d97706 !important;
    }



    .btn-edit {
      background: #3b82f6;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      min-width: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-edit:hover {
      background: #2563eb;
    }

    .btn-remove {
      background: #ef4444;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      min-width: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-remove:hover {
      background: #dc2626;
    }

    .selected-activities {
      margin-top: 32px;
    }

    .activity-list {
      space-y: 12px;
    }

    .activity-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .activity-info {
      flex: 1;
    }

    .activity-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .activity-header {
      margin-bottom: 12px;
    }

    .activity-name {
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
      font-size: 15px;
      line-height: 1.4;
    }

    .activity-category {
      font-size: 12px;
      color: #6b7280;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .activity-details {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .detail-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      font-size: 13px;
      line-height: 1.4;
    }

    .detail-label {
      font-weight: 500;
      color: #374151;
      min-width: 120px;
      flex-shrink: 0;
    }

    .detail-value {
      color: #6b7280;
      flex: 1;
    }

    .detail-value strong {
      color: #059669;
      font-weight: 600;
    }

    .activity-link {
      color: #3b82f6;
      text-decoration: none;
      font-weight: 500;
    }

    .activity-link:hover {
      text-decoration: underline;
    }

    .activity-points {
      background: #10b981;
      color: white;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 600;
      margin: 0 12px;
    }

    .points-summary {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 24px;
      margin: 32px 0;
    }

    .summary-title {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 16px;
    }

    .points-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 16px;
    }

    .point-item {
      text-align: center;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
    }

    .point-value {
      font-size: 20px;
      font-weight: 700;
      color: #3b82f6;
    }

    .point-label {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }

    .total-points {
      background: #3b82f6;
      color: white;
    }

    .total-points .point-value,
    .total-points .point-label {
      color: white;
    }

    .submit-section {
      padding: 32px;
      border-top: 1px solid #e5e7eb;
      text-align: center;
    }

    .btn-submit {
      background: #3b82f6;
      padding: 16px 32px;
      font-size: 16px;
      font-weight: 600;
    }

    .message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
      display: none;
    }

    .message.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }

    .message.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }

    .empty-state {
      text-align: center;
      padding: 32px;
      color: #6b7280;
      font-style: italic;
    }

    @media (max-width: 768px) {
      .container {
        margin: 0;
        border-radius: 0;
      }

      .header, .form-section, .activities-section, .submit-section {
        padding: 24px;
      }

      .selection-grid {
        grid-template-columns: 1fr;
      }

      .activity-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }

      .activity-actions {
        width: 100%;
        justify-content: space-between;
      }

      .activity-points {
        margin: 0;
      }

      .detail-item {
        flex-direction: column;
        gap: 4px;
      }

      .detail-label {
        min-width: auto;
        font-size: 12px;
      }

      .detail-value {
        font-size: 13px;
      }

      .points-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .points-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Registro de Atividades Complementares</h1>
      <p class="subtitle">Cada aluno precisa de 15 pontos ao longo do curso para se formar</p>
    </div>
    
    <div id="success-message" class="message success"></div>
    <div id="error-message" class="message error"></div>

    <form id="student-form">
      <div class="form-section">
        <!-- Dados do Estudante -->
        <div class="form-group">
          <label for="student-name">Nome Completo *</label>
          <input type="text" id="student-name" name="name" required placeholder="Digite seu nome completo">
        </div>

        <div class="form-group">
          <label for="student-email">Email *</label>
          <input type="email" id="student-email" name="email" required placeholder="seu.email@exemplo.com">
        </div>

        <div class="form-group">
          <label for="student-id">Matr√≠cula *</label>
          <input type="text" id="student-id" name="matricula" required placeholder="Digite sua matr√≠cula">
        </div>
        
        <div class="required-note">
          <span class="required-asterisk">*</span> Campos obrigat√≥rios
        </div>
      </div>

      <!-- Atividades Complementares -->
      <div class="activities-section">
        <h2 class="section-title">Atividades Complementares</h2>
        
        <div class="requirement-info">
          <strong>Requisitos:</strong> Cada aluno precisa de 15 pontos ao longo do curso. 
          Em cada categoria √© poss√≠vel conseguir no m√°ximo 10 pontos.
        </div>

        <div class="selection-grid">
          <!-- Seletor de Categoria -->
          <div class="form-group">
            <label for="category-select">Categoria</label>
            <select id="category-select" name="category">
              <option value="">Selecione uma categoria...</option>
              <!-- Categorias ser√£o carregadas aqui -->
            </select>
          </div>

          <!-- Seletor de Atividade -->
          <div class="form-group">
            <label for="activity-select">Atividade</label>
            <select id="activity-select" name="activity" disabled>
              <option value="">Primeiro selecione uma categoria</option>
            </select>
          </div>

          <div id="activity-details" class="activity-details" style="display: none;">
            <!-- Detalhes da atividade selecionada -->
          </div>
        </div>



        <!-- Campos Adicionais da Atividade -->
        <div id="additional-fields" class="additional-fields" style="display: none;">
          
          <!-- Unidades de Avalia√ß√£o -->
          <div class="form-group">
            <label for="units-count">Quantas Unidades de Avalia√ß√£o desta Atividade foram obtidas? *</label>
            <div class="help-text">
              Por exemplo, 3 semestres de monitoria equivalem a 3 unidades. 100 horas de cursos de idiomas equivalem a 2 unidades.
            </div>
            <input type="number" id="units-count" name="unitsCount" min="1" placeholder="Digite o n√∫mero de unidades">
          </div>

          <!-- Comprovante da Atividade -->
          <div class="form-group">
            <label for="proof-type">Comprovante da atividade *</label>
            <div class="proof-options">
              <div class="proof-option">
                <input type="radio" id="proof-link" name="proofType" value="link" checked>
                <label for="proof-link">Link do arquivo</label>
              </div>
              <div class="proof-option">
                <input type="radio" id="proof-upload" name="proofType" value="upload">
                <label for="proof-upload">Upload de arquivo</label>
              </div>
            </div>
          </div>

          <!-- Campo de Link -->
          <div id="link-section" class="form-group">
            <label for="activity-link">Link do comprovante</label>
            <div class="file-info">
              Cole o link do arquivo (Google Drive, OneDrive, etc.) ou URL do comprovante.
            </div>
            <input type="url" id="activity-link" name="activityLink" placeholder="https://drive.google.com/... ou outro link">
          </div>

          <!-- Campo de Upload -->
          <div id="upload-section" class="form-group" style="display: none;">
            <label for="activity-file">Arquivo do comprovante</label>
            <div class="file-info">
              Selecione um arquivo (PDF, imagem, documento). M√°ximo 5MB.
            </div>
            <div class="file-upload-container">
              <input type="file" id="activity-file" name="activityFile" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" style="display: none;">
              <button type="button" id="file-upload-btn" class="btn btn-upload">
                üìÅ Escolher Arquivo
              </button>
              <div id="file-selected" class="file-selected" style="display: none;">
                <span id="file-name"></span>
                <button type="button" id="remove-file-btn" class="btn btn-remove-file">√ó</button>
              </div>
            </div>
          </div>

          <!-- Coment√°rios sobre a atividade -->
          <div class="form-group">
            <label for="activity-comments">Coment√°rios sobre a atividade</label>
            <textarea id="activity-comments" name="comments" rows="4" placeholder="Sua resposta"></textarea>
          </div>

          <!-- Ano da atividade -->
          <div class="form-group">
            <label for="activity-year">Ano em que a atividade foi realizada *</label>
            <select id="activity-year" name="activityYear">
              <option value="">Selecione o ano...</option>
            </select>
          </div>

          <!-- Campo para m√∫ltiplos anos (aparece quando unidades > 1 e unidade √© "Semestre") -->
          <div id="multiple-years-section" class="form-group" style="display: none;">
            <label for="activity-years">Anos de realiza√ß√£o (separados por v√≠rgula) *</label>
            <div class="help-text">
              Como voc√™ informou mais de 1 semestre, especifique os anos. Exemplo: 2022, 2023
            </div>
            <input type="text" id="activity-years" name="activityYears" placeholder="Ex: 2022, 2023, 2024">
          </div>

          <!-- Bot√£o para Adicionar -->
          <button type="button" id="add-activity-btn" class="btn btn-add">
            Adicionar Atividade
          </button>
          
          <div class="required-note">
            <span class="required-asterisk">*</span> Campos obrigat√≥rios para adicionar a atividade
          </div>

        </div>

        <div class="selected-activities">
          <h3 class="section-title">Atividades Selecionadas</h3>
          <div id="selected-list" class="activity-list">
            <div class="empty-state">Nenhuma atividade selecionada ainda</div>
          </div>
        </div>
      </div>

      <div id="points-summary" class="points-summary" style="display: none;">
        <h3 class="summary-title">Resumo de Pontos</h3>
        <div class="points-grid">
          <div class="point-item">
            <div class="point-value" id="points-ensino">0</div>
            <div class="point-label">Ensino</div>
          </div>
          <div class="point-item">
            <div class="point-value" id="points-pesquisa">0</div>
            <div class="point-label">Pesquisa</div>
          </div>
          <div class="point-item">
            <div class="point-value" id="points-cultura">0</div>
            <div class="point-label">Cultura</div>
          </div>
          <div class="point-item">
            <div class="point-value" id="points-representacao">0</div>
            <div class="point-label">Representa√ß√£o</div>
          </div>
          <div class="point-item total-points">
            <div class="point-value" id="points-total">0</div>
            <div class="point-label">Total</div>
          </div>
        </div>
      </div>

      <div class="submit-section">
        <button type="submit" class="btn btn-submit">Enviar Registro de Atividades Complementares</button>
      </div>
    </form>
  </div>

  <!-- Modal de Confirma√ß√£o -->
  <div id="confirmation-modal" class="modal" style="display: none;">
    <div class="modal-overlay" onclick="closeConfirmationModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2>üìã Confirmar Envio do Registro</h2>
        <button class="modal-close" onclick="closeConfirmationModal()">√ó</button>
      </div>
      
      <div class="modal-body">
        <div class="confirmation-section">
          <h3>üë§ Dados do Estudante</h3>
          <div class="confirmation-data">
            <div class="data-row">
              <span class="data-label">Nome:</span>
              <span class="data-value" id="confirm-name"></span>
            </div>
            <div class="data-row">
              <span class="data-label">Email:</span>
              <span class="data-value" id="confirm-email"></span>
            </div>
            <div class="data-row">
              <span class="data-label">Matr√≠cula:</span>
              <span class="data-value" id="confirm-matricula"></span>
            </div>
          </div>
        </div>

        <div class="confirmation-section">
          <h3>üéØ Atividades Complementares</h3>
          <div id="confirm-activities" class="confirmation-activities"></div>
        </div>

        <div class="confirmation-section">
          <h3>üìä Resumo de Pontos</h3>
          <div class="points-summary-modal">
            <div class="point-row">
              <span>Ensino:</span>
              <strong id="confirm-points-ensino">0</strong>
            </div>
            <div class="point-row">
              <span>Pesquisa:</span>
              <strong id="confirm-points-pesquisa">0</strong>
            </div>
            <div class="point-row">
              <span>Cultura:</span>
              <strong id="confirm-points-cultura">0</strong>
            </div>
            <div class="point-row">
              <span>Representa√ß√£o:</span>
              <strong id="confirm-points-representacao">0</strong>
            </div>
            <div class="point-row total">
              <span>TOTAL:</span>
              <strong id="confirm-points-total">0</strong>
            </div>
          </div>
        </div>

        <div class="confirmation-section status-section">
          <div id="confirm-status" class="status-message"></div>
        </div>

        <div class="confirmation-agreement">
          <label class="checkbox-label">
            <input type="checkbox" id="confirm-agreement">
            <span>Confirmo que os dados est√£o corretos e autorizo o envio deste registro para a coordena√ß√£o.</span>
          </label>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeConfirmationModal()">
          Cancelar
        </button>
        <button type="button" class="btn btn-submit" id="confirm-send-btn" onclick="confirmAndSend()" disabled>
          ‚úÖ Confirmar e Enviar
        </button>
      </div>
    </div>
  </div>

  <script>
    // Dados das categorias e atividades (carregados dos arquivos JSON)
    let categoriesData = [];
    let activitiesData = {};
    let selectedActivities = [];
    let currentEixo = 'ensino';

    // Carregar dados dos arquivos JSON
    async function loadData() {
      // Usar dados est√°ticos diretamente para evitar problemas de MIME type
      loadFallbackData();
    }

    // Dados de fallback caso n√£o consiga carregar os JSONs
    function loadFallbackData() {
      categoriesData = [
        { id: 'ensino', name: 'Ensino', icon: 'üìñ', maxPoints: 10 },
        { id: 'pesquisa', name: 'Pesquisa', icon: 'üî¨', maxPoints: 10 },
        { id: 'cultura', name: 'Cultura e Sociedade', icon: 'üé≠', maxPoints: 10 },
        { id: 'representacao', name: 'Representa√ß√£o Estudantil', icon: 'üèõÔ∏è', maxPoints: 10 }
      ];
      
      activitiesData = {
        ensino: [
          { id: '1.1', name: 'Monitoria em disciplinas de ensino superior ou profissionalizante do Ifes', unit: 'Semestre', points: 5 },
          { id: '1.2', name: 'Est√°gio n√£o obrigat√≥rio ou extracurricular em institui√ß√µes de ensino', unit: 'Semestre (M√≠nimo de 150h)', points: 10 },
          { id: '1.3', name: 'Curso de idioma', unit: 'M√≥dulo de 50h', points: 1 },
          { id: '1.4', name: 'Visita t√©cnica', unit: 'Visita', points: 1 },
          { id: '1.5', name: 'Presen√ßa em palestra t√©cnico-cient√≠fica relacionada com os objetivos do curso', unit: 'Palestra', points: 1 },
          { id: '1.6', name: 'Presen√ßa em palestra de forma√ß√£o human√≠stica', unit: 'Palestra', points: 1 },
          { id: '1.7', name: 'Presen√ßa em defesa de Trabalho de Conclus√£o de Curso', unit: 'Participa√ß√£o', points: 1 },
          { id: '1.8', name: 'Curso relacionado com os objetivos do curso', unit: 'M√≥dulo de 8h', points: 1 },
          { id: '1.9', name: 'Disciplinas optativas que extrapolem a carga hor√°ria exigida pelo curso', unit: 'Disciplina', points: 2 },
          { id: '1.10', name: 'Participa√ß√£o em projetos integradores de ensino (extracurriculares)', unit: 'Projeto', points: 3 },
          { id: '1.11', name: 'Disciplinas cursadas em interc√¢mbio, n√£o aproveitadas no processo de dispensa', unit: 'Disciplina', points: 2 },
          { id: '1.12', name: 'Est√°gio feito em interc√¢mbio, de acordo com a DN Proen n¬∫ 01/2015', unit: 'Semestre (M√≠nimo de 150 h)', points: 10 }
        ],
        pesquisa: [
          { id: '2.1', name: 'Participa√ß√£o em projeto de pesquisa como bolsista ou volunt√°rio', unit: 'Semestre', points: 10 },
          { id: '2.2', name: 'Publica√ß√£o de artigo completo em anais de simp√≥sios ou encontros', unit: 'Publica√ß√£o', points: 3 },
          { id: '2.3', name: 'Publica√ß√£o de artigo completo em anais de congressos', unit: 'Publica√ß√£o', points: 5 },
          { id: '2.4', name: 'Publica√ß√£o de artigo completo em revista indexada em √°reas afins', unit: 'Publica√ß√£o', points: 10 },
          { id: '2.5', name: 'Participa√ß√£o em congresso, simp√≥sio, mostra de inicia√ß√£o cient√≠fica ou encontro t√©cnico-cient√≠fico em √°reas afins', unit: 'Participa√ß√£o', points: 5 },
          { id: '2.6', name: 'Premia√ß√£o ou destaque em congressos cient√≠ficos nas √°reas de forma√ß√£o do curso', unit: 'Men√ß√£o', points: 3 }
        ],
        cultura: [
          { id: '3.1', name: 'Participa√ß√£o em evento de car√°ter cultural, esportivo, social ou ambiental', unit: 'Evento', points: 2 },
          { id: '3.2', name: 'Participa√ß√£o em comiss√£o organizadora de evento ou curso de car√°ter cultural, esportivo, social ou ambiental', unit: 'Evento', points: 4 },
          { id: '3.3', name: 'Ministrante de curso relacionado com os objetivos do curso', unit: 'Hora ministrada', points: 1 },
          { id: '3.4', name: 'Ministrante de palestra relacionada com os objetivos do curso', unit: 'Palestra', points: 3 },
          { id: '3.5', name: 'Participa√ß√£o em projetos comunit√°rios e sociais relacionados aos objetivos do curso', unit: 'Projeto', points: 10 },
          { id: '3.6', name: 'Participa√ß√£o em Maratonas e outras Competi√ß√µes relacionadas aos objetivos do Curso', unit: 'Participa√ß√£o', points: 2 }
        ],
        representacao: [
          { id: '4.1', name: 'Diretorias de Gr√™mios Estudantis e Diret√≥rios Acad√™micos e Centros Acad√™micos', unit: 'Ano de Mandato', points: 7 },
          { id: '4.2', name: 'Representante de corpo discente em comiss√µes, conselhos e √≥rg√£os colegiados do Ifes', unit: 'Ano de Mandato', points: 1 }
        ]
      };
    }

    async function initializeApp() {
      await loadData();
      updateCategorySelect();
      setupEventListeners();
      setupFieldValidation();
      populateYearSelector();
      renderSelectedActivities();
      updateFileInputConfig();
    }

    function updateFileInputConfig() {
      // Atualizar configura√ß√µes do input de arquivo baseado nas vari√°veis de ambiente
      const config = window.UPLOAD_CONFIG || { maxFileSizeMB: 5, allowedFileTypes: ['.pdf','.jpg','.jpeg','.png','.doc','.docx'] };
      
      const fileInput = document.getElementById('activity-file');
      if (fileInput) {
        fileInput.setAttribute('accept', config.allowedFileTypes.join(','));
      }
      
      // Atualizar texto de ajuda
      const fileInfo = document.querySelector('#upload-section .file-info');
      if (fileInfo) {
        fileInfo.textContent = `Selecione um arquivo (${config.allowedFileTypes.join(', ')}). M√°ximo ${config.maxFileSizeMB}MB.`;
      }
    }

    function populateYearSelector() {
      const yearSelect = document.getElementById('activity-year');
      const currentYear = new Date().getFullYear();
      
      // Adicionar anos de 2000 at√© o ano atual (sem anos futuros)
      for (let year = currentYear; year >= 2000; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelect.appendChild(option);
      }
    }

    function checkMultipleYears() {
      const unitsCountInput = document.getElementById('units-count');
      const activitySelect = document.getElementById('activity-select');
      const multipleYearsSection = document.getElementById('multiple-years-section');
      const activityYearSelect = document.getElementById('activity-year');
      const activityYearsInput = document.getElementById('activity-years');
      
      // Verificar se elementos existem antes de usar
      if (!unitsCountInput || !activitySelect) return;
      
      const unitsCount = parseInt(unitsCountInput.value) || 0;
      
      if (!activitySelect.value) return;
      
      const activity = findActivityById(activitySelect.value);
      if (!activity) return;
      
      // Verificar se √© semestre e tem mais de 1 unidade
      const isSemester = activity.unit && activity.unit.toLowerCase().includes('semestre');
      const needsMultipleYears = isSemester && unitsCount > 1;
      
      if (needsMultipleYears) {
        multipleYearsSection.style.display = 'block';
        // N√£o usar required - valida√ß√£o √© feita no JavaScript
        
        // Sugerir anos baseado no ano selecionado
        if (activityYearSelect.value) {
          const baseYear = parseInt(activityYearSelect.value);
          const suggestedYears = [];
          for (let i = 0; i < unitsCount; i++) {
            suggestedYears.push(baseYear - i);
          }
          activityYearsInput.placeholder = `Ex: ${suggestedYears.reverse().join(', ')}`;
        }
      } else {
        multipleYearsSection.style.display = 'none';
        // N√£o usar required - valida√ß√£o √© feita no JavaScript
        activityYearsInput.value = '';
      }
    }

    let uploadedFileData = null; // Armazenar dados do arquivo

    function handleProofTypeChange() {
      const proofType = document.querySelector('input[name="proofType"]:checked').value;
      const linkSection = document.getElementById('link-section');
      const uploadSection = document.getElementById('upload-section');
      const activityLink = document.getElementById('activity-link');
      
      if (proofType === 'link') {
        linkSection.style.display = 'block';
        uploadSection.style.display = 'none';
        // N√£o adicionar required - valida√ß√£o √© feita no JavaScript
        uploadedFileData = null; // Limpar arquivo se mudou para link
        removeUploadedFile();
      } else {
        linkSection.style.display = 'none';
        uploadSection.style.display = 'block';
        activityLink.value = ''; // Limpar link se mudou para upload
      }
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Obter configura√ß√µes de upload
      const config = window.UPLOAD_CONFIG || { maxFileSizeMB: 5, allowedFileTypes: ['.pdf','.jpg','.jpeg','.png','.doc','.docx'] };
      
      // Validar tamanho do arquivo
      const maxSize = config.maxFileSizeMB * 1024 * 1024; // Converter MB para bytes
      if (file.size > maxSize) {
        alert(`Arquivo muito grande. O tamanho m√°ximo √© ${config.maxFileSizeMB}MB.`);
        event.target.value = '';
        return;
      }

      // Validar tipo de arquivo
      const fileName = file.name.toLowerCase();
      const fileExtension = '.' + fileName.split('.').pop();
      
      if (!config.allowedFileTypes.includes(fileExtension)) {
        alert(`Tipo de arquivo n√£o permitido. Tipos aceitos: ${config.allowedFileTypes.join(', ')}`);
        event.target.value = '';
        return;
      }

      // Ler arquivo como Base64
      const reader = new FileReader();
      reader.onload = function(e) {
        uploadedFileData = {
          name: file.name,
          type: file.type,
          size: file.size,
          data: e.target.result, // Base64
          uploadedAt: new Date().toISOString()
        };

        // Mostrar arquivo selecionado
        const fileSelectedDiv = document.getElementById('file-selected');
        const fileNameSpan = document.getElementById('file-name');
        
        fileNameSpan.textContent = `${file.name} (${formatFileSize(file.size)})`;
        fileSelectedDiv.style.display = 'flex';
        
        showMessage('success', 'Arquivo carregado com sucesso!');
      };

      reader.onerror = function() {
        alert('Erro ao ler o arquivo. Tente novamente.');
        event.target.value = '';
      };

      reader.readAsDataURL(file);
    }

    function removeUploadedFile() {
      uploadedFileData = null;
      document.getElementById('activity-file').value = '';
      document.getElementById('file-selected').style.display = 'none';
      document.getElementById('file-name').textContent = '';
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function prepareEmailData(studentData) {
      // Coletar todos os arquivos das atividades
      const attachments = [];
      const activityDetails = [];

      studentData.activities.forEach((activity, index) => {
        let proofInfo = '';
        
        if (activity.proofType === 'upload' && activity.fileData) {
          // Arquivo foi uploadado
          attachments.push({
            name: `atividade_${index + 1}_${activity.fileData.name}`,
            data: activity.fileData.data,
            type: activity.fileData.type
          });
          proofInfo = `Arquivo: ${activity.fileData.name}`;
        } else if (activity.activityLink) {
          // Link foi fornecido
          proofInfo = `Link: ${activity.activityLink}`;
        }

        activityDetails.push(`
${activity.id} - ${activity.name}
Categoria: ${getEixoName(activity.eixo)}
Unidades: ${activity.unitsCount}
Pontos: ${activity.totalPoints || activity.points}
Anos: ${activity.activityYears ? activity.activityYears.join(', ') : activity.activityYear}
Comprovante: ${proofInfo}
${activity.comments ? `Coment√°rios: ${activity.comments}` : ''}
        `);
      });

      return {
        student: studentData,
        attachments: attachments,
        emailBody: `
Registro de Atividades Complementares

DADOS DO ESTUDANTE:
Nome: ${studentData.name}
Email: ${studentData.email}
Matr√≠cula: ${studentData.matricula}

RESUMO DE PONTOS:
- Ensino: ${studentData.pointsByEixo.ensino}/10 pontos
- Pesquisa: ${studentData.pointsByEixo.pesquisa}/10 pontos
- Cultura: ${studentData.pointsByEixo.cultura}/10 pontos
- Representa√ß√£o: ${studentData.pointsByEixo.representacao}/10 pontos
TOTAL: ${studentData.totalPoints}/15 pontos

ATIVIDADES REGISTRADAS:
${activityDetails.join('\n---\n')}

Data do registro: ${new Date(studentData.registeredAt).toLocaleString('pt-BR')}
        `
      };
    }

    // Fun√ß√£o para enviar email (usando EmailJS)
    async function sendEmailWithAttachments(emailData) {
      try {
        // Verificar se as configura√ß√µes est√£o dispon√≠veis
        if (!window.EMAIL_CONFIG) {
          throw new Error('Configura√ß√µes de email n√£o encontradas');
        }

        const config = window.EMAIL_CONFIG;
        
        // Verificar se as configura√ß√µes foram definidas
        if (config.serviceId === 'your_service_id_here' || 
            config.templateId === 'your_template_id_here' || 
            config.userId === 'your_user_id_here') {
          throw new Error('Configure as credenciais do EmailJS no arquivo .env');
        }

        // Enviar para m√∫ltiplos destinat√°rios
        const destinationEmails = config.destinationEmails || [config.destinationEmail];
        console.log(`Enviando email para ${destinationEmails.length} destinat√°rio(s)...`);
        
        const sendPromises = destinationEmails.map(async (email) => {
          const templateParams = {
            to_email: email.trim(),
            student_name: emailData.student.name,
            student_email: emailData.student.email,
            student_id: emailData.student.matricula,
            total_points: emailData.student.totalPoints,
            message: emailData.emailBody,
            attachments: emailData.attachments // EmailJS suporta anexos em Base64
          };

          console.log(`Enviando para: ${email}`);
          return await emailjs.send(config.serviceId, config.templateId, templateParams, config.userId);
        });

        // Aguardar todos os envios
        const responses = await Promise.all(sendPromises);
        
        // Verificar se todos foram enviados com sucesso
        const allSuccess = responses.every(response => response.status === 200);
        
        if (allSuccess) {
          console.log(`‚úÖ Email enviado com sucesso para ${destinationEmails.length} destinat√°rio(s)!`);
          return true;
        } else {
          throw new Error('Alguns emails falharam no envio');
        }
      } catch (error) {
        console.error('Erro ao enviar email:', error);
        
        // Diferentes tipos de erro
        if (error.message.includes('Configure as credenciais')) {
          throw new Error('EmailJS n√£o configurado. Verifique o arquivo .env');
        } else if (error.message.includes('n√£o encontradas')) {
          throw new Error('Configura√ß√µes de email n√£o carregadas');
        } else {
          throw new Error('Erro no envio do email. Verifique sua conex√£o e configura√ß√µes');
        }
      }
    }

    function setupFieldValidation() {
      // Valida√ß√£o em tempo real apenas para campos b√°sicos (sempre presentes)
      const requiredFields = [
        { id: 'student-name', name: 'Nome Completo' },
        { id: 'student-email', name: 'Email' },
        { id: 'student-id', name: 'Matr√≠cula' }
      ];

      requiredFields.forEach(field => {
        const input = document.getElementById(field.id);
        if (input) {
          input.addEventListener('blur', function() {
            validateField(this, field.name);
          });
          
          input.addEventListener('input', function() {
            // Remove indica√ß√£o de erro quando o usu√°rio come√ßa a digitar
            this.classList.remove('error');
          });
        }
      });
    }

    function validateField(input, fieldName) {
      const value = input.value.trim();
      
      if (!value) {
        input.classList.add('error');
        showFieldError(input, `${fieldName} √© obrigat√≥rio.`);
        return false;
      }
      
      // Valida√ß√£o espec√≠fica para email
      if (input.type === 'email') {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(value)) {
          input.classList.add('error');
          showFieldError(input, 'Digite um email v√°lido.');
          return false;
        }
      }
      
      // Valida√ß√£o espec√≠fica para URL
      if (input.type === 'url') {
        try {
          new URL(value);
        } catch (e) {
          input.classList.add('error');
          showFieldError(input, 'Digite um link v√°lido (deve come√ßar com http:// ou https://).');
          return false;
        }
      }
      
      // Valida√ß√£o espec√≠fica para n√∫mero (unidades)
      if (input.type === 'number') {
        const numValue = parseInt(value);
        if (isNaN(numValue) || numValue < 1) {
          input.classList.add('error');
          showFieldError(input, 'Digite um n√∫mero v√°lido maior que zero.');
          return false;
        }
      }
      
      input.classList.remove('error');
      hideFieldError(input);
      return true;
    }

    function showFieldError(input, message) {
      // Remove erro anterior se existir
      hideFieldError(input);
      
      const errorDiv = document.createElement('div');
      errorDiv.className = 'field-error';
      errorDiv.textContent = message;
      errorDiv.id = input.id + '-error';
      
      input.parentNode.appendChild(errorDiv);
    }

    function hideFieldError(input) {
      const existingError = document.getElementById(input.id + '-error');
      if (existingError) {
        existingError.remove();
      }
    }

    function setupEventListeners() {
      // Event listeners para os selects
      const categorySelect = document.getElementById('category-select');
      const activitySelect = document.getElementById('activity-select');
      
      if (categorySelect) {
        categorySelect.addEventListener('change', handleCategoryChange);
      }
      
      if (activitySelect) {
        activitySelect.addEventListener('change', handleActivityChange);
      }
      
      // addButton n√£o √© mais necess√°rio - campos aparecem automaticamente

      // Event listener para o bot√£o adicionar
      const addActivityBtn = document.getElementById('add-activity-btn');
      
      if (addActivityBtn) {
        addActivityBtn.addEventListener('click', saveCompleteActivity);
      }

      // Event listeners para gerenciar m√∫ltiplos anos (s√≥ se existirem)
      setTimeout(() => {
        const unitsCountInput = document.getElementById('units-count');
        const activityYearSelect = document.getElementById('activity-year');
        
        if (unitsCountInput) {
          unitsCountInput.addEventListener('input', checkMultipleYears);
        }
        
        if (activityYearSelect) {
          activityYearSelect.addEventListener('change', checkMultipleYears);
        }
      }, 500); // Aguardar um pouco para elementos serem criados

      // Event listeners para altern√¢ncia entre link e upload
      const proofTypeRadios = document.querySelectorAll('input[name="proofType"]');
      proofTypeRadios.forEach(radio => {
        radio.addEventListener('change', handleProofTypeChange);
      });

      // Event listeners para upload de arquivo
      const fileUploadBtn = document.getElementById('file-upload-btn');
      const activityFile = document.getElementById('activity-file');
      const removeFileBtn = document.getElementById('remove-file-btn');

      if (fileUploadBtn && activityFile) {
        fileUploadBtn.addEventListener('click', () => activityFile.click());
        activityFile.addEventListener('change', handleFileUpload);
      }

      if (removeFileBtn) {
        removeFileBtn.addEventListener('click', removeUploadedFile);
      }

    }

    function updateCategorySelect() {
      const categorySelect = document.getElementById('category-select');
      if (!categorySelect || categoriesData.length === 0) return;
      
      // Limpar op√ß√µes existentes (manter apenas a primeira)
      categorySelect.innerHTML = '<option value="">Selecione uma categoria...</option>';
      
      // Adicionar categorias
      categoriesData.forEach(category => {
        const option = document.createElement('option');
        option.value = category.id;
        option.textContent = `${category.icon} ${category.name} (M√°x ${category.maxPoints} pts)`;
        categorySelect.appendChild(option);
      });
    }

    function handleCategoryChange() {
      console.log('handleCategoryChange chamada');
      const categorySelect = document.getElementById('category-select');
      const activitySelect = document.getElementById('activity-select');
      const activityDetails = document.getElementById('activity-details');
      
      const selectedCategoryId = categorySelect.value;
      console.log('Categoria selecionada:', selectedCategoryId);
      
      if (!selectedCategoryId) {
        // Nenhuma categoria selecionada
        console.log('Nenhuma categoria selecionada, limpando atividades');
        activitySelect.innerHTML = '<option value="">Primeiro selecione uma categoria</option>';
        activitySelect.disabled = true;
        activityDetails.style.display = 'none';
        return;
      }
      
      // Atualizar atividades
      const activities = activitiesData[selectedCategoryId] || [];
      console.log('Atividades para categoria', selectedCategoryId, ':', activities);
      
      activitySelect.innerHTML = '<option value="">Selecione uma atividade...</option>';
      
      activities.forEach(activity => {
        const option = document.createElement('option');
        option.value = activity.id;
        option.textContent = `${activity.id} - ${activity.name} (${activity.points} pts)`;
        activitySelect.appendChild(option);
        console.log('Atividade adicionada:', activity.name);
      });
      
      activitySelect.disabled = false;
      activityDetails.style.display = 'none';
      console.log('Seletor de atividades atualizado com', activities.length, 'op√ß√µes');
    }

    function handleActivityChange() {
      const activitySelect = document.getElementById('activity-select');
      const activityDetails = document.getElementById('activity-details');
      
      const selectedActivityId = activitySelect.value;
      
      if (!selectedActivityId) {
        activityDetails.style.display = 'none';
        return;
      }
      
      // Encontrar a atividade selecionada
      const activity = findActivityById(selectedActivityId);
      if (!activity) return;
      
      // Verificar se j√° foi selecionada
      const alreadySelected = selectedActivities.some(selected => selected.id === selectedActivityId);
      
      // Mostrar detalhes da atividade
      activityDetails.innerHTML = `
        <div class="activity-header">
          <strong>${activity.id} - ${activity.name}</strong>
        </div>
        <div class="detail-row">
          <span class="detail-label">Unidade:</span>
          <span class="detail-value">${activity.unit}</span>
        </div>
        <div class="points-badge">${activity.points} pontos</div>
        ${alreadySelected ? '<div style="color: #ef4444; font-weight: 500; margin-top: 12px; font-size: 14px;">‚ö†Ô∏è Esta atividade j√° foi adicionada</div>' : ''}
      `;
      
      activityDetails.style.display = 'block';
      
      // Mostrar campos adicionais sempre que uma atividade for selecionada
      document.getElementById('additional-fields').style.display = 'block';
    }

    let currentActivityData = null; // Armazenar dados da atividade atual

    function addSelectedActivity() {
      const categorySelect = document.getElementById('category-select');
      const activitySelect = document.getElementById('activity-select');
      
      const selectedCategoryId = categorySelect.value;
      const selectedActivityId = activitySelect.value;
      
      if (!selectedCategoryId || !selectedActivityId) return;
      
      const activity = findActivityById(selectedActivityId);
      if (!activity) return;
      
      // Verificar se j√° foi adicionada
      if (selectedActivities.some(selected => selected.id === selectedActivityId)) {
        alert('Esta atividade j√° foi adicionada!');
        return;
      }
      
      // Armazenar dados da atividade atual
      currentActivityData = {
        ...activity,
        eixo: selectedCategoryId
      };
      
      // Mostrar campos adicionais
      document.getElementById('additional-fields').style.display = 'block';
      document.getElementById('add-activity-btn').style.display = 'none';
      
      // Scroll para os campos adicionais
      document.getElementById('additional-fields').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
      });
    }

    function saveCompleteActivity() {
      const categorySelect = document.getElementById('category-select');
      const activitySelect = document.getElementById('activity-select');
      
      const selectedCategoryId = categorySelect.value;
      const selectedActivityId = activitySelect.value;
      
      if (!selectedCategoryId || !selectedActivityId) return;
      
      const activity = findActivityById(selectedActivityId);
      if (!activity) return;
      
      // Verificar se j√° foi adicionada (apenas se n√£o estiver editando)
      if (editingActivityIndex === -1 && selectedActivities.some(selected => selected.id === selectedActivityId)) {
        alert('Esta atividade j√° foi adicionada!');
        return;
      }
      
      // Coletar dados dos campos adicionais
      const unitsCount = document.getElementById('units-count').value;
      const activityLink = document.getElementById('activity-link').value;
      const comments = document.getElementById('activity-comments').value;
      const activityYear = document.getElementById('activity-year').value;
      const activityYears = document.getElementById('activity-years').value;
      const proofType = document.querySelector('input[name="proofType"]:checked').value;
      
      // Verificar se precisa de m√∫ltiplos anos
      const isSemester = activity.unit && activity.unit.toLowerCase().includes('semestre');
      const needsMultipleYears = isSemester && parseInt(unitsCount) > 1;
      
      // Validar campos obrigat√≥rios
      if (!unitsCount) {
        alert('Por favor, preencha o n√∫mero de unidades.');
        return;
      }
      
      // Validar comprovante baseado no tipo selecionado
      if (proofType === 'link') {
        if (!activityLink || activityLink.trim() === '') {
          alert('Por favor, forne√ßa o link do comprovante da atividade.');
          return;
        }
        
        // Validar formato do link
        try {
          new URL(activityLink.trim());
        } catch (e) {
          alert('Por favor, digite um link v√°lido para o comprovante (deve come√ßar com http:// ou https://).');
          return;
        }
      } else if (proofType === 'upload') {
        if (!uploadedFileData) {
          alert('Por favor, fa√ßa o upload do arquivo comprovante da atividade.');
          return;
        }
      }
      
      if (needsMultipleYears) {
        if (!activityYears) {
          alert('Por favor, especifique os anos de realiza√ß√£o da atividade.');
          return;
        }
        
        // Validar formato dos anos
        const yearsArray = activityYears.split(',').map(y => y.trim()).filter(y => y);
        if (yearsArray.length !== parseInt(unitsCount)) {
          alert(`Por favor, especifique exatamente ${unitsCount} anos (um para cada semestre).`);
          return;
        }
        
        // Validar se todos s√£o anos v√°lidos
        const currentYear = new Date().getFullYear();
        const invalidYears = yearsArray.filter(year => !/^\d{4}$/.test(year) || parseInt(year) < 2000 || parseInt(year) > currentYear);
        if (invalidYears.length > 0) {
          alert('Por favor, digite anos v√°lidos (formato: YYYY, entre 2000 e ' + currentYear + ').');
          return;
        }
      } else {
        if (!activityYear) {
          alert('Por favor, selecione o ano de realiza√ß√£o da atividade.');
          return;
        }
      }
      
      // Valida√ß√£o adicional: verificar se todos os campos obrigat√≥rios est√£o preenchidos
      const missingFields = [];
      
      if (!unitsCount || parseInt(unitsCount) < 1) {
        missingFields.push('Unidades de Avalia√ß√£o');
      }
      
      if (proofType === 'link' && (!activityLink || activityLink.trim() === '')) {
        missingFields.push('Link do Comprovante');
      } else if (proofType === 'upload' && !uploadedFileData) {
        missingFields.push('Arquivo do Comprovante');
      }
      
      if (needsMultipleYears && !activityYears) {
        missingFields.push('Anos de Realiza√ß√£o');
      } else if (!needsMultipleYears && !activityYear) {
        missingFields.push('Ano de Realiza√ß√£o');
      }
      
      if (missingFields.length > 0) {
        alert(`Por favor, preencha os seguintes campos obrigat√≥rios: ${missingFields.join(', ')}.`);
        return;
      }
      
      // Calcular pontos totais (pontos base * quantidade de unidades)
      const totalPoints = activity.points * parseInt(unitsCount);
      
      // Processar anos
      let yearsData;
      if (needsMultipleYears) {
        yearsData = activityYears.split(',').map(y => parseInt(y.trim())).sort();
      } else {
        yearsData = [parseInt(activityYear)];
      }

      // Criar atividade completa
      const completeActivity = {
        ...activity,
        eixo: selectedCategoryId,
        unitsCount: parseInt(unitsCount),
        totalPoints: totalPoints, // Pontos calculados
        proofType: proofType, // Tipo de comprovante (link ou upload)
        activityLink: proofType === 'link' ? activityLink.trim() : undefined,
        fileData: proofType === 'upload' ? uploadedFileData : undefined, // Dados do arquivo
        comments: comments.trim(),
        activityYear: needsMultipleYears ? yearsData[0] : parseInt(activityYear), // Primeiro ano para compatibilidade
        activityYears: needsMultipleYears ? yearsData : undefined, // Array de anos se m√∫ltiplos
        addedAt: editingActivityIndex === -1 ? new Date().toISOString() : selectedActivities[editingActivityIndex].addedAt,
        updatedAt: editingActivityIndex !== -1 ? new Date().toISOString() : undefined
      };
      
      if (editingActivityIndex !== -1) {
        // Atualizar atividade existente
        selectedActivities[editingActivityIndex] = completeActivity;
        editingActivityIndex = -1; // Reset do √≠ndice de edi√ß√£o
        showMessage('success', 'Atividade atualizada com sucesso!');
      } else {
        // Adicionar nova atividade
        selectedActivities.push(completeActivity);
        showMessage('success', 'Atividade adicionada com sucesso!');
      }
      
      // Resetar formul√°rio
      resetActivityForm();
      
      // Atualizar interface
      renderSelectedActivities();
      updatePointsSummary();
    }

    function resetActivityForm() {
      // Limpar sele√ß√µes
      const categorySelect = document.getElementById('category-select');
      const activitySelect = document.getElementById('activity-select');
      
      categorySelect.value = '';
      activitySelect.innerHTML = '<option value="">Primeiro selecione uma categoria</option>';
      activitySelect.disabled = true;
      document.getElementById('activity-details').style.display = 'none';
      
      // Ocultar campos adicionais
      document.getElementById('additional-fields').style.display = 'none';
      
      // Limpar campos adicionais
      document.getElementById('units-count').value = '';
      document.getElementById('activity-link').value = '';
      document.getElementById('activity-comments').value = '';
      document.getElementById('activity-year').value = '';
      document.getElementById('activity-years').value = '';
      
      // Resetar tipo de comprovante para link
      document.getElementById('proof-link').checked = true;
      handleProofTypeChange();
      
      // Limpar arquivo uploadado
      removeUploadedFile();
      
      // Ocultar se√ß√£o de m√∫ltiplos anos
      document.getElementById('multiple-years-section').style.display = 'none';
      
      // Resetar bot√£o para o estado original
      const addButton = document.getElementById('add-activity-btn');
      addButton.textContent = 'Adicionar Atividade';
      addButton.style.background = '#10b981';
      
      // Resetar dados da atividade atual e √≠ndice de edi√ß√£o
      currentActivityData = null;
      editingActivityIndex = -1;
    }



    function findActivityById(id) {
      for (const eixo in activitiesData) {
        const activity = activitiesData[eixo].find(act => act.id === id);
        if (activity) return activity;
      }
      return null;
    }

    function removeSelectedActivity(activityId) {
      selectedActivities = selectedActivities.filter(activity => activity.id !== activityId);
      renderSelectedActivities();
      updatePointsSummary();
    }

    let editingActivityIndex = -1; // √çndice da atividade sendo editada

    function editActivity(activityIndex) {
      const activity = selectedActivities[activityIndex];
      if (!activity) return;

      // Armazenar o √≠ndice da atividade sendo editada
      editingActivityIndex = activityIndex;

      // Preencher o formul√°rio com os dados da atividade
      const categorySelect = document.getElementById('category-select');
      const activitySelect = document.getElementById('activity-select');
      
      categorySelect.value = activity.eixo;
      
      // Atualizar as atividades da categoria
      handleCategoryChange();
      
      // Aguardar um momento para o select ser populado
      setTimeout(() => {
        activitySelect.value = activity.id;
        handleActivityChange();
        
        // Preencher os campos adicionais
        document.getElementById('units-count').value = activity.unitsCount || '';
        document.getElementById('activity-link').value = activity.activityLink || '';
        document.getElementById('activity-comments').value = activity.comments || '';
        document.getElementById('activity-year').value = activity.activityYear || '';
        
        // Preencher m√∫ltiplos anos se existirem
        if (activity.activityYears && activity.activityYears.length > 1) {
          document.getElementById('activity-years').value = activity.activityYears.join(', ');
        }
        
        // Verificar se precisa mostrar campo de m√∫ltiplos anos
        setTimeout(() => checkMultipleYears(), 200);
        
        // Alterar o texto do bot√£o para "Atualizar Atividade"
        const addButton = document.getElementById('add-activity-btn');
        addButton.textContent = 'Atualizar Atividade';
        addButton.style.background = '#f59e0b';
        
        // Scroll para o formul√°rio
        document.getElementById('additional-fields').scrollIntoView({ 
          behavior: 'smooth', 
          block: 'start' 
        });
      }, 100);
    }

    function renderSelectedActivities() {
      const container = document.getElementById('selected-list');
      
      if (selectedActivities.length === 0) {
        container.innerHTML = '<div class="empty-state">Nenhuma atividade selecionada ainda</div>';
        return;
      }

      container.innerHTML = selectedActivities.map((activity, index) => `
        <div class="activity-item">
          <div class="activity-info">
            <div class="activity-header">
              <div class="activity-name">${activity.id} - ${activity.name}</div>
              <div class="activity-category">${getEixoName(activity.eixo)}</div>
            </div>
            
            <div class="activity-details">
              <div class="detail-item">
                <span class="detail-label">Unidade de Medida:</span>
                <span class="detail-value">${activity.unit}</span>
              </div>
              
              ${activity.unitsCount ? `
                <div class="detail-item">
                  <span class="detail-label">Quantidade:</span>
                  <span class="detail-value">${activity.unitsCount} unidade(s)</span>
                </div>
              ` : ''}
              
              ${activity.activityYear ? `
                <div class="detail-item">
                  <span class="detail-label">${activity.activityYears && activity.activityYears.length > 1 ? 'Anos de Realiza√ß√£o:' : 'Ano de Realiza√ß√£o:'}</span>
                  <span class="detail-value">${activity.activityYears && activity.activityYears.length > 1 ? activity.activityYears.join(', ') : activity.activityYear}</span>
                </div>
              ` : ''}
              
              ${activity.totalPoints ? `
                <div class="detail-item">
                  <span class="detail-label">C√°lculo de Pontos:</span>
                  <span class="detail-value">${activity.points} pts/unidade √ó ${activity.unitsCount} = <strong>${activity.totalPoints} pts</strong></span>
                </div>
              ` : ''}
              
              ${activity.comments ? `
                <div class="detail-item">
                  <span class="detail-label">Coment√°rios:</span>
                  <span class="detail-value activity-comments">${activity.comments}</span>
                </div>
              ` : ''}
              
              ${activity.activityLink ? `
                <div class="detail-item">
                  <span class="detail-label">Comprovante:</span>
                  <span class="detail-value">
                    <a href="${activity.activityLink}" target="_blank" rel="noopener" class="activity-link">
                      üîó Ver documento
                    </a>
                  </span>
                </div>
              ` : ''}
            </div>
          </div>
          
          <div class="activity-actions">
            <div class="activity-points">${activity.totalPoints || activity.points} pts</div>
            <div class="action-buttons">
              <button type="button" class="btn btn-edit edit-btn" data-activity-index="${index}" title="Editar atividade">
                ‚úèÔ∏è
              </button>
              <button type="button" class="btn btn-remove remove-btn" data-activity-id="${activity.id}" title="Remover atividade">
                üóëÔ∏è
              </button>
            </div>
          </div>
        </div>
      `).join('');

      // Adicionar event listeners para os bot√µes de remover
      container.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const activityId = e.target.getAttribute('data-activity-id');
          if (confirm('Tem certeza que deseja remover esta atividade?')) {
            removeSelectedActivity(activityId);
          }
        });
      });

      // Adicionar event listeners para os bot√µes de editar
      container.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const activityIndex = parseInt(e.target.getAttribute('data-activity-index'));
          editActivity(activityIndex);
        });
      });
    }

    function getEixoName(eixo) {
      const category = categoriesData.find(cat => cat.id === eixo);
      return category ? category.name : eixo;
    }

    function getCategoryById(id) {
      return categoriesData.find(cat => cat.id === id);
    }

    function updatePointsSummary() {
      const pointsByEixo = {
        ensino: 0,
        pesquisa: 0,
        cultura: 0,
        representacao: 0
      };

      selectedActivities.forEach(activity => {
        pointsByEixo[activity.eixo] += activity.totalPoints || activity.points;
      });

      const totalPoints = Object.values(pointsByEixo).reduce((sum, points) => sum + points, 0);

      // Update display
      document.getElementById('points-ensino').textContent = Math.min(pointsByEixo.ensino, 10);
      document.getElementById('points-pesquisa').textContent = Math.min(pointsByEixo.pesquisa, 10);
      document.getElementById('points-cultura').textContent = Math.min(pointsByEixo.cultura, 10);
      document.getElementById('points-representacao').textContent = Math.min(pointsByEixo.representacao, 10);
      
      const validTotal = Math.min(pointsByEixo.ensino, 10) + 
                        Math.min(pointsByEixo.pesquisa, 10) + 
                        Math.min(pointsByEixo.cultura, 10) + 
                        Math.min(pointsByEixo.representacao, 10);
      
      document.getElementById('points-total').textContent = validTotal;

      // Show/hide summary
      const summary = document.getElementById('points-summary');
      if (selectedActivities.length > 0) {
        summary.style.display = 'block';
      } else {
        summary.style.display = 'none';
      }
    }

    function showMessage(type, message) {
      const successMsg = document.getElementById('success-message');
      const errorMsg = document.getElementById('error-message');
      
      if (type === 'success') {
        successMsg.textContent = message;
        successMsg.style.display = 'block';
        errorMsg.style.display = 'none';
        
        // Auto-hide success after 5 seconds
        setTimeout(() => {
          successMsg.style.display = 'none';
        }, 5000);
      } else {
        errorMsg.textContent = message;
        errorMsg.style.display = 'block';
        // N√£o ocultar mensagem de sucesso se existir
        
        // Auto-hide error after 8 seconds (mais tempo para ler)
        setTimeout(() => {
          errorMsg.style.display = 'none';
        }, 8000);
      }
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Vari√°vel global para armazenar dados do formul√°rio
    let pendingSubmitData = null;

    document.getElementById('student-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      console.log('Formul√°rio enviado - mostrando confirma√ß√£o...');
      
      // Coletar apenas dados b√°sicos do formul√°rio (n√£o os campos de atividade)
      const studentName = document.getElementById('student-name')?.value || '';
      const studentEmail = document.getElementById('student-email')?.value || '';
      const studentId = document.getElementById('student-id')?.value || '';
      
      console.log('Dados do formul√°rio coletados');
      
      const studentData = {
        name: studentName,
        email: studentEmail,
        matricula: studentId,
        activities: selectedActivities,
        pointsByEixo: {
          ensino: Math.min(selectedActivities.filter(a => a.eixo === 'ensino').reduce((sum, a) => sum + (a.totalPoints || a.points), 0), 10),
          pesquisa: Math.min(selectedActivities.filter(a => a.eixo === 'pesquisa').reduce((sum, a) => sum + (a.totalPoints || a.points), 0), 10),
          cultura: Math.min(selectedActivities.filter(a => a.eixo === 'cultura').reduce((sum, a) => sum + (a.totalPoints || a.points), 0), 10),
          representacao: Math.min(selectedActivities.filter(a => a.eixo === 'representacao').reduce((sum, a) => sum + (a.totalPoints || a.points), 0), 10)
        },
        registeredAt: new Date().toISOString()
      };
      
      console.log('Dados do estudante:', studentData);

      studentData.totalPoints = Object.values(studentData.pointsByEixo).reduce((sum, points) => sum + points, 0);

      // Preparar dados para email (incluindo arquivos)
      const emailData = prepareEmailData(studentData);

      // Valida√ß√£o detalhada dos campos obrigat√≥rios
      console.log('Iniciando valida√ß√£o...');
      const missingFields = [];
      if (!studentData.name || studentData.name.trim() === '') {
        missingFields.push('Nome Completo');
      }
      if (!studentData.email || studentData.email.trim() === '') {
        missingFields.push('Email');
      }
      if (!studentData.matricula || studentData.matricula.trim() === '') {
        missingFields.push('Matr√≠cula');
      }
      
      console.log('Campos faltando:', missingFields);
      
      if (missingFields.length > 0) {
        console.log('Valida√ß√£o falhou - campos obrigat√≥rios faltando');
        showMessage('error', `Por favor, preencha os seguintes campos obrigat√≥rios: ${missingFields.join(', ')}.`);
        
        // Focar no primeiro campo vazio
        if (!studentData.name || studentData.name.trim() === '') {
          document.getElementById('student-name').focus();
        } else if (!studentData.email || studentData.email.trim() === '') {
          document.getElementById('student-email').focus();
        } else if (!studentData.matricula || studentData.matricula.trim() === '') {
          document.getElementById('student-id').focus();
        }
        return;
      }
      
      // Valida√ß√£o de formato de email
      console.log('Validando email:', studentData.email);
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(studentData.email)) {
        console.log('Email inv√°lido');
        showMessage('error', 'Por favor, digite um email v√°lido.');
        document.getElementById('student-email').focus();
        return;
      }

      console.log('Validando atividades. Total:', selectedActivities.length);
      if (selectedActivities.length === 0) {
        console.log('Nenhuma atividade selecionada');
        showMessage('error', 'Selecione pelo menos uma atividade complementar.');
        return;
      }

      // Armazenar dados e mostrar modal de confirma√ß√£o
      pendingSubmitData = {
        studentData,
        emailData,
        form: this
      };
      
      window.showConfirmationModal(studentData);
    });

    // Debug: Verificar se script est√° carregando
    console.log('üöÄ Script carregado - inicializando aplica√ß√£o...');
    
    // Verificar se elementos existem
    setTimeout(() => {
      const form = document.getElementById('student-form');
      const categorySelect = document.getElementById('category-select');
      
      console.log('üìã Elementos encontrados:');
      console.log('- Formul√°rio:', form ? 'OK' : 'ERRO - n√£o encontrado');
      console.log('- Seletor categoria:', categorySelect ? 'OK' : 'ERRO - n√£o encontrado');
      console.log('- selectedActivities:', typeof selectedActivities, selectedActivities.length);
      console.log('- categoriesData:', typeof categoriesData, categoriesData.length);
      
      if (form) {
        console.log('‚úÖ Configurando event listener do formul√°rio...');
        // Event listener j√° est√° configurado acima
      }
    }, 1000);
    
    // Fun√ß√£o de debug
    window.debugSystem = function() {
      console.log('üîß DEBUG DO SISTEMA:');
      console.log('='.repeat(40));
      
      // Verificar elementos
      const form = document.getElementById('student-form');
      const categorySelect = document.getElementById('category-select');
      const submitBtn = document.querySelector('button[type="submit"]');
      
      console.log('üìã Elementos:');
      console.log('- Formul√°rio:', form ? '‚úÖ OK' : '‚ùå ERRO');
      console.log('- Categoria Select:', categorySelect ? '‚úÖ OK' : '‚ùå ERRO');
      console.log('- Bot√£o Submit:', submitBtn ? '‚úÖ OK' : '‚ùå ERRO');
      
      // Verificar dados
      console.log('\nüìä Dados:');
      console.log('- selectedActivities:', selectedActivities.length, 'atividades');
      console.log('- categoriesData:', categoriesData.length, 'categorias');
      
      // Verificar dados do formul√°rio
      if (form) {
        const formData = new FormData(form);
        console.log('\nüìù Dados do Formul√°rio:');
        console.log('- Nome:', formData.get('name') || 'VAZIO');
        console.log('- Email:', formData.get('email') || 'VAZIO');
        console.log('- Matr√≠cula:', formData.get('matricula') || 'VAZIO');
      }
      
      // Mostrar atividades
      if (selectedActivities.length > 0) {
        console.log('\nüéØ Atividades Selecionadas:');
        selectedActivities.forEach((activity, i) => {
          console.log(`${i + 1}. ${activity.name} - ${activity.totalPoints || activity.points} pts`);
        });
      }
      
      // Testar submit manualmente
      console.log('\nüß™ Testando submit manual...');
      if (form) {
        try {
          form.dispatchEvent(new Event('submit', { bubbles: true }));
          console.log('‚úÖ Submit disparado com sucesso');
        } catch (error) {
          console.error('‚ùå Erro ao disparar submit:', error);
        }
      }
      
      console.log('='.repeat(40));
    };
    
    // Fun√ß√µes do Modal de Confirma√ß√£o (globais para onclick)
    window.showConfirmationModal = function(studentData) {
      // Preencher dados do estudante
      document.getElementById('confirm-name').textContent = studentData.name;
      document.getElementById('confirm-email').textContent = studentData.email;
      document.getElementById('confirm-matricula').textContent = studentData.matricula;
      
      // Preencher atividades
      const activitiesContainer = document.getElementById('confirm-activities');
      activitiesContainer.innerHTML = studentData.activities.map(activity => `
        <div class="activity-summary">
          <div class="activity-summary-title">${activity.id} - ${activity.name}</div>
          <div class="activity-summary-details">
            Categoria: ${getEixoName(activity.eixo)} | 
            Unidades: ${activity.unitsCount} | 
            Pontos: ${activity.totalPoints || activity.points} | 
            Ano: ${activity.activityYears ? activity.activityYears.join(', ') : activity.activityYear}
          </div>
        </div>
      `).join('');
      
      // Preencher pontos
      document.getElementById('confirm-points-ensino').textContent = studentData.pointsByEixo.ensino + ' pts';
      document.getElementById('confirm-points-pesquisa').textContent = studentData.pointsByEixo.pesquisa + ' pts';
      document.getElementById('confirm-points-cultura').textContent = studentData.pointsByEixo.cultura + ' pts';
      document.getElementById('confirm-points-representacao').textContent = studentData.pointsByEixo.representacao + ' pts';
      document.getElementById('confirm-points-total').textContent = studentData.totalPoints + ' / 15 pts';
      
      // Mostrar status
      const status = studentData.totalPoints >= 15 
        ? 'üéì Parab√©ns! Voc√™ atingiu os 15 pontos necess√°rios para formatura!' 
        : `üìä Faltam ${15 - studentData.totalPoints} pontos para atingir o requisito de formatura.`;
      document.getElementById('confirm-status').textContent = status;
      
      // Resetar checkbox
      const checkbox = document.getElementById('confirm-agreement');
      checkbox.checked = false;
      document.getElementById('confirm-send-btn').disabled = true;
      
      // Mostrar modal
      document.getElementById('confirmation-modal').style.display = 'flex';
      document.body.style.overflow = 'hidden'; // Prevenir scroll
    }

    window.closeConfirmationModal = function() {
      document.getElementById('confirmation-modal').style.display = 'none';
      document.body.style.overflow = 'auto';
      pendingSubmitData = null;
    }

    // Event listener para checkbox de confirma√ß√£o
    document.getElementById('confirm-agreement').addEventListener('change', function() {
      document.getElementById('confirm-send-btn').disabled = !this.checked;
    });

    // ========================================
    // Fun√ß√µes de Integra√ß√£o com Google Sheets e Drive
    // ========================================
    let googleApiLoaded = false;

    async function initializeGoogleAPI() {
      if (!window.GOOGLE_CONFIG?.enabled || googleApiLoaded) return;
      
      try {
        console.log('üîÑ Inicializando Google API...');
        
        await new Promise((resolve, reject) => {
          if (typeof gapi !== 'undefined') {
            gapi.load('client', () => resolve());
          } else {
            console.warn('‚ö†Ô∏è Google API n√£o carregada');
            reject(new Error('Google API n√£o dispon√≠vel'));
          }
        });
        
        await gapi.client.init({
          apiKey: window.GOOGLE_CONFIG.apiKey,
          discoveryDocs: [
            'https://sheets.googleapis.com/$discovery/rest?version=v4',
            'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'
          ]
        });
        
        googleApiLoaded = true;
        console.log('‚úÖ Google API inicializada com sucesso');
      } catch (error) {
        console.error('‚ùå Erro ao inicializar Google API:', error);
        throw error;
      }
    }

    async function saveToGoogleSheets(studentData) {
      if (!googleApiLoaded || !window.GOOGLE_CONFIG?.enabled) {
        throw new Error('Google API n√£o est√° dispon√≠vel');
      }

      try {
        console.log('üìä Salvando dados no Google Sheets...');
        
        // Preparar dados para a planilha
        const timestamp = new Date().toLocaleString('pt-BR');
        const activitiesText = studentData.activities.map(activity => 
          `${activity.id} - ${activity.name} (${activity.totalPoints || activity.points} pts)`
        ).join('; ');
        
        const filesText = studentData.activities
          .filter(activity => activity.fileData)
          .map(activity => activity.fileData.name)
          .join('; ');

        // Dados da linha
        const values = [
          timestamp,
          studentData.name,
          studentData.email,
          studentData.matricula,
          studentData.totalPoints,
          studentData.pointsByEixo.ensino,
          studentData.pointsByEixo.pesquisa,
          studentData.pointsByEixo.cultura,
          studentData.pointsByEixo.representacao,
          activitiesText,
          filesText,
          studentData.totalPoints >= 15 ? 'FORMADO' : 'EM ANDAMENTO'
        ];

        // Adicionar linha √† planilha
        const response = await gapi.client.sheets.spreadsheets.values.append({
          spreadsheetId: window.GOOGLE_CONFIG.sheetsId,
          range: `${window.GOOGLE_CONFIG.worksheet}!A:L`,
          valueInputOption: 'RAW',
          resource: {
            values: [values]
          }
        });

        console.log('‚úÖ Dados salvos no Google Sheets com sucesso');
        return response;
      } catch (error) {
        console.error('‚ùå Erro ao salvar no Google Sheets:', error);
        throw error;
      }
    }

    async function processGoogleIntegration(studentData) {
      if (!window.GOOGLE_CONFIG?.enabled) {
        console.log('‚ÑπÔ∏è Integra√ß√£o com Google desabilitada');
        return null;
      }

      try {
        console.log('üîÑ Processando integra√ß√£o com Google...');
        
        // Inicializar API se necess√°rio
        if (!googleApiLoaded) {
          await initializeGoogleAPI();
        }
        
        // Salvar dados na planilha
        await saveToGoogleSheets(studentData);
        
        console.log('‚úÖ Integra√ß√£o com Google conclu√≠da!');
        return { sheetsUpdated: true };
      } catch (error) {
        console.error('‚ùå Erro na integra√ß√£o com Google:', error);
        throw error;
      }
    }

    window.confirmAndSend = async function() {
      if (!pendingSubmitData) return;
      
      const { studentData, emailData, form } = pendingSubmitData;
      
      // Fechar modal
      closeConfirmationModal();
      
      // Mostrar mensagem de processamento
      showMessage('success', '‚è≥ Processando envio...');
      
      // Salvar no localStorage
      console.log('Salvando no localStorage...');
      const existingData = JSON.parse(localStorage.getItem('studentRecords') || '[]');
      existingData.push(studentData);
      localStorage.setItem('studentRecords', JSON.stringify(existingData));
      console.log('Dados salvos com sucesso');

      // Integra√ß√£o com Google Sheets (se habilitada)
      let googleResult = null;
      if (window.GOOGLE_CONFIG?.enabled) {
        try {
          showMessage('success', 'üîÑ Salvando no Google Sheets...');
          googleResult = await processGoogleIntegration(studentData);
          console.log('‚úÖ Dados salvos no Google Sheets');
        } catch (error) {
          console.error('Erro na integra√ß√£o com Google:', error);
          setTimeout(() => {
            showMessage('error', `‚ö†Ô∏è Erro ao salvar no Google Sheets: ${error.message}`);
          }, 2000);
        }
      }

      const status = studentData.totalPoints >= 15 ? 'FORMADO! üéì' : `Faltam ${15 - studentData.totalPoints} pontos para se formar`;
      
      // Enviar email automaticamente se houver atividades cadastradas
      if (selectedActivities.length > 0) {
        // Verificar se EmailJS est√° dispon√≠vel e configurado
        const emailConfigured = window.EMAIL_CONFIG && 
                               window.EMAIL_CONFIG.serviceId !== 'your_service_id_here' &&
                               typeof emailjs !== 'undefined';
        
        if (emailConfigured) {
          try {
            await sendEmailWithAttachments(emailData);
            showMessage('success', `‚úÖ Registro salvo e enviado por email com sucesso! Total: ${studentData.totalPoints}/15 pontos. Status: ${status}`);
          } catch (error) {
            console.error('Erro ao enviar email:', error);
            showMessage('success', `Registro salvo com sucesso! Total: ${studentData.totalPoints}/15 pontos. Status: ${status}`);
            
            // Mostrar erro espec√≠fico do email ap√≥s um delay
            setTimeout(() => {
              showMessage('error', `‚ö†Ô∏è Email n√£o enviado: ${error.message}`);
            }, 2000);
          }
        } else {
          // EmailJS n√£o configurado, apenas salvar
          showMessage('success', `Registro salvo com sucesso! Total: ${studentData.totalPoints}/15 pontos. Status: ${status}`);
          
          // Informar sobre configura√ß√£o do email
          setTimeout(() => {
            showMessage('error', 'üìß Para envio autom√°tico por email, configure o EmailJS no arquivo .env');
          }, 2000);
        }
      } else {
        showMessage('success', `Registro salvo com sucesso! Total: ${studentData.totalPoints}/15 pontos. Status: ${status}`);
      }
      
      // Limpar formul√°rio
      form.reset();
      selectedActivities = [];
      renderSelectedActivities();
      updatePointsSummary();
    }

    // Inicializar aplica√ß√£o
    initializeApp();
    
    // Inicializar Google API se habilitado
    if (window.GOOGLE_CONFIG?.enabled) {
      console.log('üîÑ Google Sheets habilitado - inicializando...');
      initializeGoogleAPI().catch(error => {
        console.error('‚ùå Erro ao inicializar Google API:', error);
        console.log('‚ÑπÔ∏è Verifique as configura√ß√µes no arquivo .env');
      });
    } else {
      console.log('‚ÑπÔ∏è Google Sheets desabilitado. Para ativar, configure ENABLE_GOOGLE_INTEGRATION=true no .env');
    }
  </script>
</body>
</html>